function [All_I_lambda,It_Mm] = combine_n_extract_I_dt_Mm6(root_dir,RunDirs)
%% Collect all optical emissions and the input parameters
%  Produce plots of Intensity Modulation and time-shifts as
%  function of peak Energy, flickering-frequency, source altitude,
%  Excitation threshold. 
%  
%  This function is a glorified script that uses hard-coded paths
%  to the data directories and loops through all result-directories
%  looking for files with time-variations of column-rates of
%  optical emissions and excitation-rates. 
% 
% Calling:
%  [All_I_lambda,It_Mm] = combine_n_extract_I_dt_Mm5(root_dir,RunDirs)
% Input:
%  root_dir - Full path to root-directoty of the Runs-directories
%             (Optional argument, defaults to:
%             '/media/bgu001/5f5e8978-a828-4fd4-aabf-2032a3fb895b/Data/Bjorns-panic-repository/Etrp-tdms';) 
%  RunDirs  - Cell-array of Runs-directories where all
%             results-directories from the time-dependent
%             electron-transport calculations are stored (Optional
%             argument, defaults to: {'Run_PnL20190828'})
% Output:
%  All_I_lambda - cell-array with cell-arrays of all time-series of
%                 column emission-rates, sorted in columns as:
%                 all_I4278,all_I6730,all_I7774,...
%                 all_I8446,all_IO1S,all_IO1D,...
%                 all_I7774_O,all_I7774_O2,...
%                 all_I8446_O,all_I8446_O2};
% It_Mm         - Cell-array with the intensity maxima and minima
%                 and the corresponding timing. First column
%                 contains directory-name, and string-headings for
%                 the rows ('I_max', 'I_min', 't_max','t_min'). The
%                 first row contains, dir-name, and
%                 wavelengths. The rest of the cell-array contains
%                 arrays with the corresponding parameters.
% 
% The script produces plots of:
%  IMA and dt as function peak Energy of FABs plotted in subplots
%  for flickering_frequency for source altitude at 3000 km 
%
%  IMA and dt as function flickering_frequency in subplots for 
%  peak energy of FABs for source altitude at 3000 km
% 
%  IMA and as a function of pitch-angle width and source altitude
%
%  IMA as a function of excitation threshold
% 
%  dtmax as a function of excitation threshold

%% This is a behemot of a function-script
% Therefore this is the contents section
%       Lines   Section
% *   67 -   95 Settings etc 
% *   97 -  353 Data-reading and processing
% *  355 -  381 Load run-parameters-settings
% *  383 -  594 Sub-set identification
% *  597 -  820 Figure 1
% *  823 - 1047 Figure 2
% * 1049 - 1143 Figure 3
% * 1145 - 1185 Figure 4
% * 1188 - 1241 Figure 5
% * 1243 - 1269 sub-functions

%   Copyright © 2019 Bjorn Gustavsson, <bjorn.gustavsson@irf.se>
%   This is free software, licensed under GNU GPL version 2 or later

%% Base-directory of result-data
%  This separation makes it easy to have result-directories from
%  different runs in different subdirectories and merge the results
%  here
if nargin < 1 || isempty(root_dir)
  root_dir = '/media/bgu001/5f5e8978-a828-4fd4-aabf-2032a3fb895b/Data/Bjorns-panic-repository/Etrp-tdms';
end
%% Default results-directories. 
if nargin < 2 || isempty(RunDirs)
  RunDirs = {'Run_PnL20190828'};
end

%% Settings for data-reading phase:
plot_n_check = 1;         % Plot time-series of intensities
plot_n_check_pause = 0.1; % dwell-time

%% Plot-settings for results-plots
disp_n_wait = 0.5;
ftsza = 11;
ftszLT = 15;
clrs_BRrK = {[0 0 1],[1 0 0],[.6 0 0],[0 0 0]};
%% axis-limits for the different plots
ax_ff_IMA     = [3  12 0 90]; % [3 12 0 1.05];
ax_Ef_IMA     = [2   9 0 90]; % [2  9 0 1.05];
ax_dtheta_IMA = [0  70 0 90]; % [0 16 0 1.05];
ax_ExcT_IMA   = [0  20 0 90];
ax_ExcT_dt    = [0  20 0 30];
ax_z0_IMA     = [1500 4500 0 90];

ax_ff_dt     = [3  12 -1 22];
ax_Ef_dt     = [2   9 -1 22];
ax_dtheta_dt = [0 100 -1 22];

%% Reading the time-series of column-intensities
CP = {};
iIdt = 1;
for i2 = 1:numel(RunDirs)
  cd(root_dir)
  cd(RunDirs{i2})
  dDir = dir;            % Move into the Run-dirs
  for i1 = 3:numel(dDir)
    cd(root_dir)
    cd(RunDirs{i2})
    if dDir(i1).isdir
      cd(dDir(i1).name) % In each Run-dir move into the data-dirs
      try
        load curr_par.mat curr_par % Load parameters for the current run
        CP(iIdt,:) = curr_par(:); %#ok<*AGROW>
        % Load time-series of column-intensities
        load I_lambda_of_t.mat t I_4278 I_6730 I_7774 I_8446 I_O1D I_7774_O2 I_8446_O2 I_O1S I_7774_O I_8446_O
        all_I4278{iIdt} = I_4278;
        all_I6730{iIdt} = I_6730;
        all_I7774{iIdt} = I_7774;
        all_I8446{iIdt} = I_8446;
        all_I7774_O{iIdt} = I_7774_O;
        all_I8446_O{iIdt} = I_8446_O;
        all_I7774_O2{iIdt} = I_7774_O2;
        all_I8446_O2{iIdt} = I_8446_O2;
        all_IO1S{iIdt} = I_O1S;
        all_IO1D{iIdt} = I_O1D;
        
        %% Identify local maxima and minima
        %% 4278
        [t4278M,I4278M,t4278m,I4278m] = local_minMaxFinder(t,I_4278);
        %% 6730
        [t6730M,I6730M,t6730m,I6730m] = local_minMaxFinder(t,I_6730);
        %% 7774
        [t7774M,I7774M,t7774m,I7774m] = local_minMaxFinder(t,I_7774);
        %% 8446
        [t8446M,I8446M,t8446m,I8446m] = local_minMaxFinder(t,I_8446);
        %% 7774_O
        [t7774_OM,I7774_OM,t7774_Om,I7774_Om] = local_minMaxFinder(t,I_7774_O);
        %% 8446_O
        [t8446_OM,I8446_OM,t8446_Om,I8446_Om] = local_minMaxFinder(t,I_8446_O);
        %% 7774_O2
        [t7774_O2M,I7774_O2M,t7774_O2m,I7774_O2m] = local_minMaxFinder(t,I_7774_O2);
        %% 8446_O2
        [t8446_O2M,I8446_O2M,t8446_O2m,I8446_O2m] = local_minMaxFinder(t,I_8446_O2);
        %% O1S
        [tO1SM,IO1SM,tO1Sm,IO1Sm] = local_minMaxFinder(t,I_O1S);
        %% O1D
        [tO1DM,IO1DM,tO1Dm,IO1Dm] = local_minMaxFinder(t,I_O1D);
        
        par_n_run = [dDir(i1).name,'-',RunDirs{i2}];
        if plot_n_check  % Then we plot the time-series with minima
                         % and MAXIMA marked
          clf
          plot_ItMm(t,I_4278,t4278M,I4278M,t4278m,I4278m,1,'4278 A',[.1 0 1])
          plot_ItMm(t,I_6730,t6730M,I6730M,t6730m,I6730m,2,'6730 A',[.8 0 0])
          plot_ItMm(t,I_7774,t7774M,I7774M,t7774m,I7774m,3,'7774 A',[.5 0 0])
          plot_ItMm(t,I_8446,t8446M,I8446M,t8446m,I8446m,4,'8446 A',[.1 0 0])
          plot_ItMm(t,I_O1S,tO1SM,IO1SM,tO1Sm,IO1Sm,5,'O1S',[0 1 0])
          plot_ItMm(t,I_O1D,tO1DM,IO1DM,tO1Dm,IO1Dm,6,'O1D',[1 0 0])
          
          xlabel(par_n_run),ylabel(iIdt),title(i1)
          pause(plot_n_check_pause)
        end
        % Save away the extreme-values and the time of them for
        % each data-directory
        %                1           2      3      4      5      6    7        8         9       10        11
        It_Mm{iIdt} = {par_n_run, 4278,  6730,  7774,  8446, 5577, 6300, 7774.01   7774.02  8446.01   8446.02
                      't_MAX',  t4278M,t6730M,t7774M,t8446M,tO1SM,tO1DM,t7774_OM,t7774_O2M,t8446_OM,t8446_O2M
                      't_min',  t4278m,t6730m,t7774m,t8446m,tO1Sm,tO1Dm,t7774_Om,t7774_O2m,t8446_Om,t8446_O2m
                      'I_MAX',  I4278M,I6730M,I7774M,I8446M,IO1SM,IO1DM,I7774_OM,I7774_O2M,I8446_OM,I8446_O2M
                      'I_min',  I4278m,I6730m,I7774m,I8446m,IO1Sm,IO1Dm,I7774_Om,I7774_O2m,I8446_Om,I8446_O2m };
        fprintf('===>>> this went OK for %s\n',pwd)
        iIdt = iIdt + 1;
      catch
        fprintf('Everythings not right in directory: %s\n',pwd)
      end
    end
  end
end
All_I_lambda = {all_I4278,all_I6730,all_I7774,...
                all_I8446,all_IO1S,all_IO1D,...
                all_I7774_O,all_I7774_O2,...
                all_I8446_O,all_I8446_O2};

%% Calculate time-shifts between local peaks of the
%  intensities in different wavelengths 
idx_r_Tmax = 2;
idx_r_Tmin = 3;
for i1 = numel(It_Mm):-1:1
  %try
    idxM = 2:numel(It_Mm{i1}{idx_r_Tmax,2}(1:end-1));
    if numel(idxM) < 2
      idxM = [idxM,idxM+1];
    end
    tMax4278 = It_Mm{i1}{idx_r_Tmax,2};%(idxM);
    tMax6730 = It_Mm{i1}{idx_r_Tmax,3};%(idxM);
    tMax7774 = It_Mm{i1}{idx_r_Tmax,4};%(idxM);
    tMax8446 = It_Mm{i1}{idx_r_Tmax,5};%(idxM);
    tMaxO1S  = It_Mm{i1}{idx_r_Tmax,6};%(idxM);
    tMaxO1D  = It_Mm{i1}{idx_r_Tmax,7};%(idxM);
    tMax7774O = It_Mm{i1}{idx_r_Tmax,8};%(idxM);
    tMax7774O2 = It_Mm{i1}{idx_r_Tmax,9};%(idxM);
    tMax8446O = It_Mm{i1}{idx_r_Tmax,10};%(idxM);
    tMax8446O2 = It_Mm{i1}{idx_r_Tmax,11};%(idxM);
    % 6730 - 4278
    [dtmax(i1,1),stdtmax(i1,1),dTmax{i1,1}] = dt_avgstd(tMax4278(2:end-1),tMax6730(2:end-1));
    [dtmax(i1,2),stdtmax(i1,2),dTmax{i1,2}] = dt_avgstd(tMax4278(2:end-1),tMax7774(2:end-1));
    [dtmax(i1,3),stdtmax(i1,3),dTmax{i1,3}] = dt_avgstd(tMax4278(2:end-1),tMax8446(2:end-1));
    [dtmax(i1,4),stdtmax(i1,4),dTmax{i1,4}] = dt_avgstd(tMax4278(2:end-1),tMaxO1S(2:end-1));
    [dtmax(i1,5),stdtmax(i1,5),dTmax{i1,5}] = dt_avgstd(tMax4278(2:end-1),tMaxO1D(2:end-1));
    
    [dtmax(i1,6),stdtmax(i1,2),dTmax{i1,2}] = dt_avgstd(tMax4278(2:end-1),tMax7774O(2:end-1));
    [dtmax(i1,7),stdtmax(i1,2),dTmax{i1,2}] = dt_avgstd(tMax4278(2:end-1),tMax7774O2(2:end-1));
    
    [dtmax(i1,8),stdtmax(i1,3),dTmax{i1,3}] = dt_avgstd(tMax4278(2:end-1),tMax8446O(2:end-1));
    [dtmax(i1,9),stdtmax(i1,3),dTmax{i1,3}] = dt_avgstd(tMax4278(2:end-1),tMax8446O2(2:end-1));
    
end
%% Calculate time-shifts between local valeys of the
%  intensities in different wavelengths 
for i1 = numel(It_Mm):-1:1
  %try
    idxM = 2:numel(It_Mm{i1}{idx_r_Tmax,2}(1:end-1));
    if numel(idxM) < 2
      idxM = [idxM,idxM+1];
    end
    tmin4278 = It_Mm{i1}{idx_r_Tmin,2};%(idxM);
    tmin6730 = It_Mm{i1}{idx_r_Tmin,3};%(idxM);
    tmin7774 = It_Mm{i1}{idx_r_Tmin,4};%(idxM);
    tmin8446 = It_Mm{i1}{idx_r_Tmin,5};%(idxM);
    tminO1S  = It_Mm{i1}{idx_r_Tmin,6};%(idxM);
    tminO1D  = It_Mm{i1}{idx_r_Tmin,7};%(idxM);
    tmin7774O = It_Mm{i1}{idx_r_Tmin,8};%(idxM);
    tmin7774O2 = It_Mm{i1}{idx_r_Tmin,9};%(idxM);
    tmin8446O = It_Mm{i1}{idx_r_Tmin,10};%(idxM);
    tmin8446O2 = It_Mm{i1}{idx_r_Tmin,11};%(idxM);
    
    [dtmin(i1,1),stdtmin(i1,1),dTmin{i1,1}] = dt_avgstd(tmin4278(2:end-1),tmin6730(2:end-1));
    [dtmin(i1,2),stdtmin(i1,2),dTmin{i1,2}] = dt_avgstd(tmin4278(2:end-1),tmin7774(2:end-1));
    [dtmin(i1,3),stdtmin(i1,3),dTmin{i1,3}] = dt_avgstd(tmin4278(2:end-1),tmin8446(2:end-1));
    [dtmin(i1,4),stdtmin(i1,4),dTmin{i1,4}] = dt_avgstd(tmin4278(2:end-1),tminO1S(2:end-1));
    [dtmin(i1,5),stdtmin(i1,5),dTmin{i1,5}] = dt_avgstd(tmin4278(2:end-1),tminO1D(2:end-1));
    
    [dtmin(i1,6),stdtmin(i1,2),dTmin{i1,2}] = dt_avgstd(tmin4278(2:end-1),tmin7774O(2:end-1));
    [dtmin(i1,7),stdtmin(i1,2),dTmin{i1,2}] = dt_avgstd(tmin4278(2:end-1),tmin7774O2(2:end-1));
    
    [dtmin(i1,8),stdtmin(i1,3),dTmin{i1,3}] = dt_avgstd(tmin4278(2:end-1),tmin8446O(2:end-1));
    [dtmin(i1,9),stdtmin(i1,3),dTmin{i1,3}] = dt_avgstd(tmin4278(2:end-1),tmin8446O2(2:end-1));
end

%% Extract peak intensities and Estimate the steady background intensities.
for i1 = numel(It_Mm):-1:1
  if numel(It_Mm{i1}{3,2}) > 1
    I4278_max_at_max(i1,1:numel(It_Mm{i1}{2,2})) = It_Mm{i1}{4,2};
    I4278_min_at_max(i1,1:numel(It_Mm{i1}{2,2})) = interp1(It_Mm{i1}{3,2},It_Mm{i1}{5,2},It_Mm{i1}{2,2},'linear');
  else
    I4278_max_at_max(i1,1:numel(It_Mm{i1}{2,2})) = It_Mm{i1}{2,2};
    I4278_min_at_max(i1,1:numel(It_Mm{i1}{2,2})) = nan;
  end
  if numel(It_Mm{i1}{3,3}) > 1
    I6730_max_at_max(i1,1:numel(It_Mm{i1}{2,3})) = It_Mm{i1}{4,3};
    I6730_min_at_max(i1,1:numel(It_Mm{i1}{2,3})) = interp1(It_Mm{i1}{3,3},It_Mm{i1}{5,3},It_Mm{i1}{2,3},'linear');
  else
    I6730_max_at_max(i1,1:numel(It_Mm{i1}{2,3})) = It_Mm{i1}{4,3};
    I6730_min_at_max(i1,1:numel(It_Mm{i1}{2,3})) = nan;
  end
  if numel(It_Mm{i1}{3,4}) > 1
    I7774_max_at_max(i1,1:numel(It_Mm{i1}{2,4})) = It_Mm{i1}{4,4};
    I7774_min_at_max(i1,1:numel(It_Mm{i1}{2,4})) = interp1(It_Mm{i1}{3,4},It_Mm{i1}{5,4},It_Mm{i1}{2,4},'linear');
  else
    I7774_max_at_max(i1,1:numel(It_Mm{i1}{2,4})) = It_Mm{i1}{4,4};
    I7774_min_at_max(i1,1:numel(It_Mm{i1}{2,4})) = nan;
  end
  if numel(It_Mm{i1}{3,5}) > 1
    I8446_max_at_max(i1,1:numel(It_Mm{i1}{2,5})) = It_Mm{i1}{4,5};
    I8446_min_at_max(i1,1:numel(It_Mm{i1}{2,5})) = interp1(It_Mm{i1}{3,5},It_Mm{i1}{5,5},It_Mm{i1}{2,5},'linear');
  else
    I8446_max_at_max(i1,1:numel(It_Mm{i1}{2,5})) = It_Mm{i1}{4,5};
    I8446_min_at_max(i1,1:numel(It_Mm{i1}{2,5})) = nan;
  end
  if numel(It_Mm{i1}{3,6}) > 1
    I5577_max_at_max(i1,1:numel(It_Mm{i1}{2,6})) = It_Mm{i1}{4,6};
    I5577_min_at_max(i1,1:numel(It_Mm{i1}{2,6})) = interp1(It_Mm{i1}{3,6},It_Mm{i1}{5,6},It_Mm{i1}{2,6},'linear');
  else
    I5577_max_at_max(i1,1:numel(It_Mm{i1}{2,6})) = It_Mm{i1}{4,6};
    I5577_min_at_max(i1,1:numel(It_Mm{i1}{2,6})) = nan;
  end
  if numel(It_Mm{i1}{3,7}) > 1
    I6300_max_at_max(i1,1:numel(It_Mm{i1}{2,7})) = It_Mm{i1}{4,7};
    I6300_min_at_max(i1,1:numel(It_Mm{i1}{2,7})) = interp1(It_Mm{i1}{3,7},It_Mm{i1}{5,7},It_Mm{i1}{2,7},'linear');
  else
    I6300_max_at_max(i1,1:numel(It_Mm{i1}{2,7})) = It_Mm{i1}{4,7};
    I6300_min_at_max(i1,1:numel(It_Mm{i1}{2,7})) = nan;
  end
  if numel(It_Mm{i1}{3,8}) > 1
    I7774O_max_at_max(i1,1:numel(It_Mm{i1}{2,8})) = It_Mm{i1}{4,8};
    I7774O_min_at_max(i1,1:numel(It_Mm{i1}{2,8})) = interp1(It_Mm{i1}{3,8},It_Mm{i1}{5,8},It_Mm{i1}{2,8},'linear');
  else
    I7774O_max_at_max(i1,1:numel(It_Mm{i1}{2,8})) = It_Mm{i1}{4,8};
    I7774O_min_at_max(i1,1:numel(It_Mm{i1}{2,8})) = nan;
  end
  if numel(It_Mm{i1}{3,9}) > 1
    I7774O2_max_at_max(i1,1:numel(It_Mm{i1}{2,9})) = It_Mm{i1}{4,9};
    I7774O2_min_at_max(i1,1:numel(It_Mm{i1}{2,9})) = interp1(It_Mm{i1}{3,9},It_Mm{i1}{5,9},It_Mm{i1}{2,9},'linear');
  else
    I7774O2_max_at_max(i1,1:numel(It_Mm{i1}{2,9})) = It_Mm{i1}{4,9};
    I7774O2_min_at_max(i1,1:numel(It_Mm{i1}{2,9})) = nan;
  end
  if numel(It_Mm{i1}{3,10}) > 1
    I8446O_max_at_max(i1,1:numel(It_Mm{i1}{2,10})) = It_Mm{i1}{4,10};
    I8446O_min_at_max(i1,1:numel(It_Mm{i1}{2,10})) = interp1(It_Mm{i1}{3,10},It_Mm{i1}{5,10},It_Mm{i1}{2,10},'linear');
  else
    I8446O_max_at_max(i1,1:numel(It_Mm{i1}{2,10})) = It_Mm{i1}{4,10};
    I8446O_min_at_max(i1,1:numel(It_Mm{i1}{2,10})) = nan;
  end
  if numel(It_Mm{i1}{3,11}) > 1
    I8446O2_max_at_max(i1,1:numel(It_Mm{i1}{2,11})) = It_Mm{i1}{4,11};
    I8446O2_min_at_max(i1,1:numel(It_Mm{i1}{2,11})) = interp1(It_Mm{i1}{3,11},It_Mm{i1}{5,11},It_Mm{i1}{2,11},'linear');
  else
    I8446O2_max_at_max(i1,1:numel(It_Mm{i1}{2,11})) = It_Mm{i1}{4,11};
    I8446O2_min_at_max(i1,1:numel(It_Mm{i1}{2,11})) = nan;
  end
end

%% Calculate the relative modulation amplitude
for i1 = size(I4278_min_at_max):-1:1,
  % try
  if numel(It_Mm{i1}{2,2})
    I_mamp(i1,1) = nanmedian(1-I4278_min_at_max(i1,2:end-1)./I4278_max_at_max(i1,2:end-1));
    I_mamp(i1,2) = nanmedian(1-I6730_min_at_max(i1,2:end-1)./I6730_max_at_max(i1,2:end-1));
    I_mamp(i1,3) = nanmedian(1-I7774_min_at_max(i1,2:end-1)./I7774_max_at_max(i1,2:end-1));
    I_mamp(i1,4) = nanmedian(1-I8446_min_at_max(i1,2:end-1)./I8446_max_at_max(i1,2:end-1));
    I_mamp(i1,5) = nanmedian(1-I5577_min_at_max(i1,2:end-1)./I5577_max_at_max(i1,2:end-1));
    I_mamp(i1,6) = nanmedian(1-I6300_min_at_max(i1,2:end-1)./I6300_max_at_max(i1,2:end-1));
    
    I_mamp(i1,7) = nanmedian(1-I7774O_min_at_max(i1,2:end-1)./I7774O_max_at_max(i1,2:end-1));
    I_mamp(i1,8) = nanmedian(1-I7774O2_min_at_max(i1,2:end-1)./I7774O2_max_at_max(i1,2:end-1));
    
    I_mamp(i1,9) = nanmedian(1-I8446O_min_at_max(i1,2:end-1)./I8446O_max_at_max(i1,2:end-1));
    I_mamp(i1,10) = nanmedian(1-I8446O2_min_at_max(i1,2:end-1)./I8446O2_max_at_max(i1,2:end-1));
    
    stdI_mamp(i1,1) = nanstd(1-I4278_min_at_max(i1,2:end-1)./I4278_max_at_max(i1,2:end-1));
    stdI_mamp(i1,2) = nanstd(1-I6730_min_at_max(i1,2:end-1)./I6730_max_at_max(i1,2:end-1));
    stdI_mamp(i1,4) = nanstd(1-I8446_min_at_max(i1,2:end-1)./I8446_max_at_max(i1,2:end-1));
    stdI_mamp(i1,3) = nanstd(1-I7774_min_at_max(i1,2:end-1)./I7774_max_at_max(i1,2:end-1));
    stdI_mamp(i1,5) = nanstd(1-I5577_min_at_max(i1,2:end-1)./I5577_max_at_max(i1,2:end-1));
    stdI_mamp(i1,6) = nanstd(1-I6300_min_at_max(i1,2:end-1)./I6300_max_at_max(i1,2:end-1));
  end
end

E_levelsOnN2 = [4278 18.75   6
                6730 7.3532  3
                7774 10.74   2
                8446 10.99   1
                5577 4.19    5
                6300 1.967   4];

%% Load the input-parameters-log-file
%  This merging of the parameters for the runs, kept in CP, and the
%  parameters in the "pars_of_ItMm_dirnames.txt" directory is a
%  "straddling legacy hack". The reading of the file here should be
%  phased out, and successively more run-parameters should be saved
%  away in curr_par
FID = fopen('pars_of_ItMm_dirnames.txt','r');
%C = textread(FID,'%f%f%f%f%f%f%f%f%f%f%f%s');
C = textscan(FID, '%f%f%f%f%f%f%f%f%f%f%f%s','commentstyle','%');
fclose(FID);       %1 2 3 4 5 6 7 8 9 0 1

pitch_angle_widths = [10 30 60]; % Q-D hard-coded version for
                                 % handling pitch-angle widths
pars_of_ItMm = cell2mat(C(:,1:end-1));

p_o_ItMm(:,1)  = (1:size(CP,1))';        % Running directory index
p_o_ItMm(:,2)  = cell2mat(CP(:,2));      % Frequency of modulation
p_o_ItMm(:,3)  = cell2mat(CP(:,1))/1e3;  % Source altitude
p_o_ItMm(:,5)  = cell2mat(CP(:,5))/1e3;  % Peak energy of FAB
p_o_ItMm(:,7)  = 1;                      % Flux-type flag (FAB: 1)
p_o_ItMm(:,8)  = ( cellfun(@(x) isequal(x,'H'),CP(:,6)') - ... % Modulation
                   cellfun(@(x) isequal(x,'S'),CP(:,6)') );    % type, H:1 S:-1, P:0
p_o_ItMm(:,9)  = pitch_angle_widths(cellfun(@numel, CP(:,4))); % Pitch-angle: 10, 30, 60
p_o_ItMm(:,10) = 1;                      % Pitch-angle-distribution flag/Dummy
p_o_ItMm(:,11) = 1;                      % Modulation type type: amplitude: 1, energy:-1

pars_of_ItMm(:,[1:3,5:end]) = p_o_ItMm(:,[1:3,5:end]);

%% Sub-sets identification suitable for plotting
% Here we identify the column indices for the different parameters
% of the pars_of_ItMm array
idx_f = 2;    % modulation frequency
idx_z0 = 3;   % source altitude
idx_Asc = 4;  % scaling of thermospheric densities
idx_Ef = 5;   % peak energy of FAB
% idxLET = 6; % low-energy-tail (for Gaussian-type spectra)
idxSteb = 7;  % supra-thermal electron burst (FAB)
idxH = 8;     % Modulation-type (Harmonic/Pulse/Square)
idxtheta = 9; % Pitch-angle-width
thetaFA = 10; % Pitch-angle-distribution-type TBD/Dummy
% idxAmEm = 11; % Flux/Energy-modulation


%  1 indices to runs with E_f 7 keV, z0: 3000 km, FA
%  harmonic modulation all frequencies: [5, 7 10] Hz
i_Ef7_z3000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                   pars_of_ItMm(:,idx_Ef) == 7 & ...
                   pars_of_ItMm(:,idxH) == 1 & ...
                   pars_of_ItMm(:,idx_z0) == 3000 & ...
                   pars_of_ItMm(:,idxSteb) == 1 & ...
                   pars_of_ItMm(:,idxtheta) == thetaFA);
%  2 indices to runs with E_f 5 keV, z0: 3000 km, FA
%  harmonic modulation all frequencies: [5, 7 10] Hz
i_Ef5_z3000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                   pars_of_ItMm(:,idx_Ef) == 5 & ...
                   pars_of_ItMm(:,idxH) == 1 & ...
                   pars_of_ItMm(:,idx_z0) == 3000 & ...
                   pars_of_ItMm(:,idxSteb) == 1 & ...
                   pars_of_ItMm(:,idxtheta) == thetaFA);
%  3 indices to runs with E_f 3 keV, z0: 3000 km, FA
%  harmonic modulation all frequencies: [5, 7 10] Hz
i_Ef3_z3000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                   pars_of_ItMm(:,idx_Ef) == 3 & ...
                   pars_of_ItMm(:,idxH) == 1 & ...
                   pars_of_ItMm(:,idx_z0) == 3000 & ...
                   pars_of_ItMm(:,idxSteb) == 1 & ...
                   pars_of_ItMm(:,idxtheta) == thetaFA);


%  4 indices to runs with E_f 7 keV, z0: 4000 km, FA
%  harmonic modulation all frequencies: [5, 7 10] Hz
i_Ef7_z4000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                   pars_of_ItMm(:,idx_Ef) == 7 & ...
                   pars_of_ItMm(:,idxH) == 1 & ...
                   pars_of_ItMm(:,idx_z0) == 4000 & ...
                   pars_of_ItMm(:,idxSteb) == 1 & ...
                   pars_of_ItMm(:,idxtheta) == thetaFA);
%  5 indices to runs with E_f 5 keV, z0: 4000 km, FA
%  harmonic modulation all frequencies: [5, 7 10] Hz
i_Ef5_z4000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                   pars_of_ItMm(:,idx_Ef) == 5 & ...
                   pars_of_ItMm(:,idxH) == 1 & ...
                   pars_of_ItMm(:,idx_z0) == 4000 & ...
                   pars_of_ItMm(:,idxSteb) == 1 & ...
                   pars_of_ItMm(:,idxtheta) == thetaFA);
%  6 indices to runs with E_f 3 keV, z0: 4000 km, FA
%  harmonic modulation all frequencies: [5, 7 10] Hz
i_Ef3_z4000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                   pars_of_ItMm(:,idx_Ef) == 3 & ...
                   pars_of_ItMm(:,idxH) == 1 & ...
                   pars_of_ItMm(:,idx_z0) == 4000 & ...
                   pars_of_ItMm(:,idxSteb) == 1 & ...
                   pars_of_ItMm(:,idxtheta) == thetaFA);


% 7o variation with source height: z0 3000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 5
i_f5_z2000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                  pars_of_ItMm(:,idxH) == 1 & ...
                  pars_of_ItMm(:,idxSteb) == 1 & ...
                  pars_of_ItMm(:,idx_f)==5 & ...
                  pars_of_ItMm(:,idx_z0)==2000 & ...
                  pars_of_ItMm(:,end)==1 & ...
                  pars_of_ItMm(:,idxtheta) == thetaFA);
% 7p variation with source height: z0 2000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 7
i_f7_z2000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                  pars_of_ItMm(:,idxH) == 1 & ...
                  pars_of_ItMm(:,idxSteb) == 1 & ...
                  pars_of_ItMm(:,idx_f)==7 & ...
                  pars_of_ItMm(:,idx_z0)==2000 & ...
                  pars_of_ItMm(:,end)==1 & ...
                  pars_of_ItMm(:,idxtheta) == thetaFA);
% 7q variation with source height: z0 2000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 10
i_f10_z2000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                   pars_of_ItMm(:,idxH) == 1 & ...
                   pars_of_ItMm(:,idxSteb) == 1 & ...
                   pars_of_ItMm(:,idx_f)==10 & ...
                   pars_of_ItMm(:,idx_z0)==2000 & ...
                   pars_of_ItMm(:,end)==1 & ...
                   pars_of_ItMm(:,idxtheta) == thetaFA);

% 7a variation with source height: z0 3000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 5
i_f5_z3000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                  pars_of_ItMm(:,idxH) == 1 & ...
                  pars_of_ItMm(:,idxSteb) == 1 & ...
                  pars_of_ItMm(:,idx_f)==5 & ...
                  pars_of_ItMm(:,idx_z0)==3000 & ...
                  pars_of_ItMm(:,end)==1 & ...
                  pars_of_ItMm(:,idxtheta) == thetaFA);
% 7b variation with source height: z0 3000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 7
i_f7_z3000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                  pars_of_ItMm(:,idxH) == 1 & ...
                  pars_of_ItMm(:,idxSteb) == 1 & ...
                  pars_of_ItMm(:,idx_f)==7 & ...
                  pars_of_ItMm(:,idx_z0)==3000 & ...
                  pars_of_ItMm(:,end)==1 & ...
                  pars_of_ItMm(:,idxtheta) == thetaFA);
% 7c variation with source height: z0 3000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 10
i_f10_z3000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                   pars_of_ItMm(:,idxH) == 1 & ...
                   pars_of_ItMm(:,idxSteb) == 1 & ...
                   pars_of_ItMm(:,idx_f)==10 & ...
                   pars_of_ItMm(:,idx_z0)==3000 & ...
                   pars_of_ItMm(:,end)==1 & ...
                   pars_of_ItMm(:,idxtheta) == thetaFA);

% 8a variation with source height: z0 4000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 10
i_f5_z4000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                  pars_of_ItMm(:,idxH) == 1 & ...
                  pars_of_ItMm(:,idxSteb) == 1 & ...
                  pars_of_ItMm(:,idx_f)==5 & ...
                  pars_of_ItMm(:,idx_z0)==4000 & ...
                  pars_of_ItMm(:,end)==1 & ...
                  pars_of_ItMm(:,idxtheta) == thetaFA);
% 8b variation with source height: z0 4000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 5
i_f7_z4000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                  pars_of_ItMm(:,idxH) == 1 & ...
                  pars_of_ItMm(:,idxSteb) == 1 & ...
                  pars_of_ItMm(:,idx_f)==7 & ...
                  pars_of_ItMm(:,idx_z0)==4000 & ...
                  pars_of_ItMm(:,end)==1 & ...
                  pars_of_ItMm(:,idxtheta) == thetaFA);
% 8c variation with source height: z0 4000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 5
i_f10_z4000 = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                   pars_of_ItMm(:,idxH) == 1 & ...
                   pars_of_ItMm(:,idxSteb) == 1 & ...
                   pars_of_ItMm(:,idx_f)==10 & ...
                   pars_of_ItMm(:,idx_z0)==4000 & ...
                   pars_of_ItMm(:,end)==1 & ...
                   pars_of_ItMm(:,idxtheta) == thetaFA);

% 9a variation with source height: z0 3000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 5
i_f5_z3000_theta = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                        pars_of_ItMm(:,idxH) == 1 & ...
                        pars_of_ItMm(:,idxSteb) == 1 & ...
                        pars_of_ItMm(:,idx_f)==5 & ...
                        pars_of_ItMm(:,idx_Ef)==3 & ...
                        pars_of_ItMm(:,idx_z0)==3000 & ...
                        pars_of_ItMm(:,end)==1);
% 9b variation with source height: z0 3000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 7
i_f7_z3000_theta = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                        pars_of_ItMm(:,idxH) == 1 & ...
                        pars_of_ItMm(:,idxSteb) == 1 & ...
                        pars_of_ItMm(:,idx_f)==7 & ...
                        pars_of_ItMm(:,idx_Ef)==3 & ...
                        pars_of_ItMm(:,idx_z0)==3000 & ...
                        pars_of_ItMm(:,end)==1);
% 9c variation with source height: z0 3000 km, P-n-L
%  steb, Sine-wave, theta-max 3, f = 10 - not correct! TODO:fix
i_f10_z3000_theta = find(pars_of_ItMm(:,idx_Asc) == 0 & ...
                         pars_of_ItMm(:,idxH) == 1 & ...
                         pars_of_ItMm(:,idxSteb) == 1 & ...
                         pars_of_ItMm(:,idx_f)==10 & ...
                         pars_of_ItMm(:,idx_Ef)==3 & ...
                         pars_of_ItMm(:,idx_z0)==3000 & ...
                         pars_of_ItMm(:,end)==1);

i_f5_E3_z = find(pars_of_ItMm(:,idxtheta) == thetaFA & ...
                  pars_of_ItMm(:,idx_Asc) == 0 & ...
                  pars_of_ItMm(:,idxH) == 1 & ...
                  pars_of_ItMm(:,idxSteb) == 1 & ...
                  pars_of_ItMm(:,idx_f)==5 & ...
                  pars_of_ItMm(:,idx_Ef)==3 & ...
                  pars_of_ItMm(:,end)==1);

i_f10_E3_z = find(pars_of_ItMm(:,idxtheta) == thetaFA & ...
                  pars_of_ItMm(:,idx_Asc) == 0 & ...
                  pars_of_ItMm(:,idxH) == 1 & ...
                  pars_of_ItMm(:,idxSteb) == 1 & ...
                  pars_of_ItMm(:,idx_f)==10 & ...
                  pars_of_ItMm(:,idx_Ef)==3 & ...
                  pars_of_ItMm(:,end)==1);

iOmega_3_f5    = find(pars_of_ItMm(:,idxtheta) == thetaFA & ...
                      pars_of_ItMm(:,idx_z0) == 3000 & ...
                      pars_of_ItMm(:,idx_Ef) == 3 & ...
                      pars_of_ItMm(:,idxH) == 1 & ...
                      pars_of_ItMm(:,idx_f) == 5);

iOmega_3_f7   = find(pars_of_ItMm(:,idxtheta) == thetaFA & ...
                     pars_of_ItMm(:,idx_z0) == 3000 & ...
                     pars_of_ItMm(:,idx_Ef) == 3 & ...
                     pars_of_ItMm(:,idxH) == 1 & ...
                     pars_of_ItMm(:,idx_f) == 7);

iOmega_3_f10   = find(pars_of_ItMm(:,idxtheta) == thetaFA & ...
                      pars_of_ItMm(:,idx_z0) == 3000 & ...
                      pars_of_ItMm(:,idx_Ef) == 3 & ...
                      pars_of_ItMm(:,idxH) == 1 & ...
                      pars_of_ItMm(:,idx_f) == 10);


%% Figure 1: subplots for IMA and dt as function Ef plotted with
%  subplots for f_f for source altitude at 3000 ('.-')

figure('position',[845, 292, 926, 553])
sph231 = subplot(2,3,1);
set(gca,'fontsize',ftsza)
ph_f = plot_pars_n_pars(pars_of_ItMm,...  % Etrp-parameters array
                        100*I_mamp,...    % Y-values, relative modulation amplitude, in per cent
                        i_Ef3_z3000,...   % run-indices to plot, E-flickering 3kEv, z0 3000 km
                        idx_f,...         % index to parameters for X-variable
                        1:4,...           % index for parameters in Y-variable
                        100*stdI_mamp,...     %,...
                        ax_ff_IMA,... % axis limits
                        'E_{max}: 3 keV',... % title-string
                        '',...            % x-label-string
                        'IM (%)',...     % y-label-string
                        ftszLT,...            % font-size
                        disp_n_wait,...
                        [],...
                        clrs_BRrK);     % display-pars-n-pause
hold on

set(gca,...
    'xticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])

sph234 = subplot(2,3,4);
set(gca,'fontsize',ftsza)
ph_f3 = plot_pars_n_pars(pars_of_ItMm,...
                         dtmax*1e3,...
                         i_Ef3_z3000,...
                         idx_f,...
                         1:3,...
                         stdtmax,...
                         ax_ff_dt,...
                         '',...
                         '',...
                         'dt (ms)',...
                         ftszLT,...
                         disp_n_wait,...
                         [],...
                         clrs_BRrK(2:end));
set(gca,...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])
hold on

ph_f3b = plot_pars_n_pars(pars_of_ItMm,...
                          dtmin*1e3,...
                          i_Ef3_z3000,...
                          idx_f,...
                          1:3,...
                          [],...
                          ax_ff_dt,...
                          '',...
                          '',...
                          '',...
                          ftszLT,...
                          disp_n_wait,...
                          [],...
                          clrs_BRrK(2:end));


sph232 = subplot(2,3,2);
set(gca,'fontsize',ftsza)
ph_f = plot_pars_n_pars(pars_of_ItMm,...
                        100*I_mamp,...
                        i_Ef5_z3000,...
                        idx_f,...
                        1:4,...
                        100*stdI_mamp,...
                        ax_ff_IMA,...
                        'E_{max}: 5 keV',...
                        '',...
                        '',...
                        ftszLT,...
                        disp_n_wait,...
                        [],...
                        clrs_BRrK);
set(gca,...
    'xticklabel','',...
    'yticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])
hold on



sph235 = subplot(2,3,5);
set(gca,'fontsize',ftsza)
ph_f3 = plot_pars_n_pars(pars_of_ItMm,...
                        dtmax*1e3,...
                        i_Ef5_z3000,...
                        idx_f,...
                        1:3,...
                        stdtmax,...
                        ax_ff_dt,...
                        '',...
                        'frequency (Hz)',...
                        '',...
                        ftszLT,...
                        disp_n_wait,...
                        [],...
                        clrs_BRrK(2:end));
hold on

set(gca,'box','off')
ph_f3b = plot_pars_n_pars(pars_of_ItMm,...
                          dtmin*1e3,...
                          i_Ef5_z3000,...
                          idx_f,...
                          1:3,...
                          [],...
                          ax_ff_dt,...
                          '',...
                          '',...
                          '',...
                          ftszLT,...
                          disp_n_wait,...
                          [],...
                          clrs_BRrK(2:end));

set(ph_f3b,'linewidth',1)
set(gca,...
    'yticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])

sph233 = subplot(2,3,3);
set(gca,...
    'fontsize',ftsza)
ph_f = plot_pars_n_pars(pars_of_ItMm,...
                        100*I_mamp,...
                        i_Ef7_z3000,...
                        idx_f,...
                        1:4,...
                        100*stdI_mamp,...
                        ax_ff_IMA,...
                        'E_{max}: 7 keV',...
                        '',...
                        '',...
                        ftszLT,...
                        disp_n_wait,...
                        [],...
                        clrs_BRrK);
hold on
set(gca,...
    'xticklabel','',...
    'yticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])


sph236 = subplot(2,3,6);
set(gca,...
    'fontsize',ftsza)
ph_f3 = plot_pars_n_pars(pars_of_ItMm,...
                         dtmax*1e3,...
                         i_Ef7_z3000,...
                         idx_f,...
                         1:3,...
                         stdtmax,...
                         ax_ff_dt,...
                         '',...
                         '',...
                         '',...
                         ftszLT,...
                         disp_n_wait,...
                         [],...
                         clrs_BRrK(2:end));
hold on

ph_f3b = plot_pars_n_pars(pars_of_ItMm,...
                          dtmin*1e3,...
                          i_Ef7_z3000,...
                          idx_f,...
                          1:3,...
                          [],...
                          ax_ff_dt,...
                          '',...
                          '',...
                          '',...
                          ftszLT,...
                          disp_n_wait,...
                          [],...
                          clrs_BRrK(2:end));
set(ph_f3b,'linewidth',1)
set(gca,'box','off')
set(gca,...
    'yticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])

h_leg = legend(ph_f(:),...
               '4278',...
               '6730',...
               '7774',...
               '8446',...
               'location','northeast');

set(h_leg,'position',get(h_leg,'position')+[0.02 0 0 0])
axes(sph236)

h_leg2 = legend([ph_f3(:);ph_f3(1);ph_f3b(1)],...
                '6730 - 4278',...
                '7774 - 4278',...
                '8446 - 4278',...
                'dt @peak',...
                'dt @min',...
                'location','northeast');
set(h_leg2,'position',get(h_leg2,'position')+[0.02 0.1 0 0])

set(sph234,'position',get(sph234,'position')+[ 0    0.1 0 0])
set(sph236,'position',get(sph236,'position')+[-0.1  0.1 0 0])
set(sph235,'position',get(sph235,'position')+[-0.05 0.1 0 0])
set(sph233,'position',get(sph233,'position')+[-0.1  0   0 0])
set(sph232,'position',get(sph232,'position')+[-0.05 0   0 0])


%% Figure 2: subplots for IMA and dt as function f_f plotted with
%  subplots for Ef for source altitude at 3000 ('.-')
figure('position',[845, 292, 926, 553])
sph231 = subplot(2,3,1);
set(gca,'fontsize',ftsza)
ph_E = plot_pars_n_pars(pars_of_ItMm,...  % Etrp-parameters array
                        100*I_mamp,...    % Y-values, relative modulation amplitude
                        i_f5_z3000,...    % run-indices to plot, E-flickering 3kEv, z0 3000 km
                        idx_Ef,...        % index to parameters for X-variable
                        1:4,...           % index for parameters in Y-variable
                        100*stdI_mamp,...
                        ax_Ef_IMA,... % axis limits
                        'f_{f}: 5 Hz',... % title-string
                        '',...            % x-label-string
                        'IM (%)',...     % y-label-string
                        ftszLT,...            % font-size
                        disp_n_wait,...
                        [],...
                        clrs_BRrK);     % display-pars-n-pause
hold on

set(gca,...
    'xticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])

sph234 = subplot(2,3,4);
ph_E2 = plot_pars_n_pars(pars_of_ItMm,...
                         dtmax*1e3,...
                         i_f5_z3000,...
                         idx_Ef,...
                         1:3,...
                         stdtmax,...
                         ax_Ef_dt,...
                         '',...
                         'E_{max} (keV)',...
                         'dt (ms)',...
                         ftszLT,...
                         disp_n_wait,...
                         [],...
                         clrs_BRrK(2:end));
hold on

ph_E2b = plot_pars_n_pars(pars_of_ItMm,...
                          dtmin*1e3,...
                          i_f5_z3000,...
                          idx_Ef,...
                          1:3,...
                          [],...
                          ax_Ef_dt,...
                          '',...
                          'E_{max} (keV)',...
                          'dt (ms)',...
                          ftszLT,...
                          disp_n_wait,...
                          [],...
                          clrs_BRrK(2:end));
hold on
set(ph_E2b,'linewidth',1)

set(gca,'box','off',...
        'fontsize',ftsza,...
        'tickdir','out',...
        'ticklength',[0.02 0.04])

sph232 = subplot(2,3,2);
set(gca,'fontsize',ftsza)
ph_E = plot_pars_n_pars(pars_of_ItMm,...  % Etrp-parameters array
                        100*I_mamp,...    % Y-values, relative modulation amplitude
                        i_f7_z3000,...    % run-indices to plot, E-flickering 3kEv, z0 3000 km
                        idx_Ef,...        % index to parameters for X-variable
                        1:4,...           % index for parameters in Y-variable
                        100*stdI_mamp,...
                        ax_Ef_IMA,... % axis limits
                        'f_{f}: 7 Hz',... % title-string
                        '',...            % x-label-string
                        '',...            % y-label-string
                        ftszLT,...            % font-size
                        disp_n_wait,...
                        [],...
                        clrs_BRrK);     % display-pars-n-pause
hold on
set(gca,...
    'xticklabel','',...
    'yticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])

sph235 = subplot(2,3,5);
set(gca,...
    'fontsize',ftsza)
ph_E2 = plot_pars_n_pars(pars_of_ItMm,...
                         dtmax*1e3,...
                         i_f7_z3000,...
                         idx_Ef,...
                         1:3,...
                         stdtmax,...
                         ax_Ef_dt,...
                         '',...
                         'E_{max} (keV)',...
                         '',...
                         ftszLT,...
                         disp_n_wait,...
                         [],...
                         clrs_BRrK(2:end));
hold on

ph_E2b = plot_pars_n_pars(pars_of_ItMm,...
                          dtmin*1e3,...
                          i_f7_z3000,...
                          idx_Ef,...
                          1:3,...
                          [],...
                          ax_Ef_dt,...
                          '',...
                          'E_{max} (keV)',...
                          '',...
                          ftszLT,...
                          disp_n_wait,...
                          [],...
                          clrs_BRrK(2:end));
hold on
set(ph_E2b,'linewidth',1)
set(gca,...
    'yticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])

sph233 = subplot(2,3,3);
set(gca,...
    'fontsize',ftsza)
ph_E = plot_pars_n_pars(pars_of_ItMm,...  % Etrp-parameters array
                        100*I_mamp,...    % Y-values, relative modulation amplitude
                        i_f10_z3000,...   % run-indices to plot, E-flickering 3kEv, z0 3000 km
                        idx_Ef,...        % index to parameters for X-variable
                        1:4,...           % index for parameters in Y-variable
                        100*stdI_mamp,...
                        ax_Ef_IMA,... % axis limits
                        'f_{f}: 10 Hz',... % title-string
                        '',...            % x-label-string
                        '',...            % y-label-string
                        ftszLT,...            % font-size
                        disp_n_wait,...
                        [],...
                        clrs_BRrK);     % display-pars-n-pause
hold on
set(gca,...
    'xticklabel','',...
    'yticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])

sph236 = subplot(2,3,6);
set(gca,...
    'fontsize',ftsza)
ph_E2 = plot_pars_n_pars(pars_of_ItMm,...
                         dtmax*1e3,...
                         i_f10_z3000,...
                         idx_Ef,...
                         1:3,...
                         stdtmax,...
                         ax_Ef_dt,...
                         '',...
                         'E_{max} (keV)',...
                         '',...
                         ftszLT,...
                         disp_n_wait,...
                         [],...
                         clrs_BRrK(2:end));
hold on

ph_E2b = plot_pars_n_pars(pars_of_ItMm,...
                          dtmin*1e3,...
                          i_f10_z3000,...
                          idx_Ef,...
                          1:3,...
                          [],...
                          ax_Ef_dt,...
                          '',...
                          'E_{max} (keV)',...
                          '',...
                          ftszLT,...
                          disp_n_wait,...
                          [],...
                          clrs_BRrK(2:end));
hold on
set(ph_E2b,'linewidth',1)
set(gca,...
    'yticklabel','',...
    'box','off',...
    'tickdir','out',...
    'ticklength',[0.02 0.04])

h_leg = legend(ph_E(:),...
               '4278',...
               '6730',...
               '7774',...
               '8446');
set(h_leg,'position',get(h_leg,'position')+[0.03 0 0 0])


% sph236 = subplot(2,3,6);
axes(sph236)
set(gca,'fontsize',ftsza)

h_leg2 = legend([ph_E2(:);ph_E2(1);ph_E2b(1)],...                  
                '6730 - 4278',...
                '7774 - 4278',...
                '8446 - 4278',...
                'dt @peak',...
                'dt @min',...
                'location','northeast');
% This "works" with some manual labour: '$\hat{I}_{7774} \leftrightarrow \hat{I}_{4278}$',...

set(h_leg2,'position',get(h_leg2,'position')+[0.03 0.1 0 0])

set(sph234,'position',get(sph234,'position')+[ 0    0.1 0 0])
set(sph236,'position',get(sph236,'position')+[-0.1  0.1 0 0])
set(sph235,'position',get(sph235,'position')+[-0.05 0.1 0 0])
set(sph233,'position',get(sph233,'position')+[-0.1  0   0 0])
set(sph232,'position',get(sph232,'position')+[-0.05 0   0 0])

%% Figure 3: subplots for IMA and as a function of pitch-angle
%  width and source altitude

figure
%sph231 = 
subplot(2,3,2);
set(gca,'fontsize',ftsza)
ph5 = plot_pars_n_pars(pars_of_ItMm,...  % Etrp-parameters array
                       100*I_mamp,...    % Y-values, relative modulation amplitude
                       i_f5_z3000_theta,... % run-indices to plot, E-flickering 3kEv, z0 3000 km
                       idxtheta,...         % index to parameters for X-variable
                       1:4,...           % index for parameters in Y-variable
                       [],...
                       ax_dtheta_IMA,... % axis limits
                       'IM vs \theta_{max}',... % title-string
                       '\theta_{max}',...            % x-label-string
                       '',...     % y-label-string
                       ftszLT,...            % font-size
                       disp_n_wait,...
                       '.-',...
                        clrs_BRrK);
hold on
set(ph5,'linewidth',1)
hold on


subplot(2,3,2);
set(gca,'fontsize',ftsza)
ph10 = plot_pars_n_pars(pars_of_ItMm,...  % Etrp-parameters array
                        100*I_mamp,...        % Y-values, relative modulation amplitude
                        i_f10_z3000_theta,... % run-indices to plot, E-flickering 3kEv, z0 3000 km
                        idxtheta,...         % index to parameters for X-variable
                        1:4,...            % index for parameters in Y-variable
                        [],...
                        ax_dtheta_IMA,...  % axis limits
                        'IM vs  \theta_{max}',... % title-string
                        '\theta_{max} (deg)',...             % x-label-string
                        '',...             % y-label-string
                        ftszLT,...             % font-size
                        disp_n_wait,...
                        '.--',...
                        clrs_BRrK); % display-pars-n-pause
set(ph10,'linewidth',1)

set(gca,'xtick',[0 30 60])

subplot(2,3,1);
set(gca,'fontsize',ftsza)

ph_z0_f5 = plot_pars_n_pars(pars_of_ItMm,...  % Etrp-parameters array                                 
                            100*I_mamp,...
                            i_f5_E3_z,... % run-indices to plot, E-flickering 3kEv, z0 3000 km        
                            idx_z0,...
                            1:4,...              % index for parameters in Y-variable
                            [],...
                            ax_z0_IMA,...  % axis limits
                            'IM vs z_0',...               % title-string
                            'z_{0} (km)',...   % x-label-string
                            'IM (%)',...     % y-label-string
                            ftszLT,...               % font-size
                            disp_n_wait,...
                            '.-',...
                            clrs_BRrK);     % display-pars-n-pause
set(ph_z0_f5,'linewidth',1)

hold on
ph_z0_f10 = plot_pars_n_pars(pars_of_ItMm,...  % Etrp-parameters array                                 
                             100*I_mamp,...
                             i_f10_E3_z,... % run-indices to plot, E-flickering 3kEv, z0 3000 km        
                             idx_z0,...
                             1:4,...              % index for parameters in Y-variable
                             [],...
                             ax_z0_IMA,...  % axis limits
                             '',...               % title-string
                             'z_0 (km)',...   % x-label-string
                             'IM (%)',...     % y-label-string
                             ftszLT,...               % font-size
                             disp_n_wait,...
                             '.--',...
                             clrs_BRrK);
set(ph_z0_f10,'linewidth',1)


h_leg12 = legend([ph_z0_f5(:);ph_z0_f5(1);ph_z0_f10(:)],...
       '4278',...
       '6730',...
       '7774',...
       '8446',...
       'f_f: 5 Hz',...
       'f_f: 10 Hz');

set(h_leg12,'position',get(h_leg12,'position')+[0.03 0.1 0 0])

set(gcf,'position',[405 460 835 514])
set(h_leg12,'position',[0.644542343883663   0.635418403742820   0.127544910179641   0.268725680933852])

%% Figure 4: IMA vs Ethreshold
figure
cmp = [ 0            0            0
        0.6          0            0
        0.9          0            0.1
        1            0.2          0
        0.3          1            0
        0            0            1];
colormap(cmp)
phO = plot(E_levelsOnN2(3:end,2),...
           100*I_mamp(i_Ef3_z3000,[3 4 5 6]),...
           '-','linewidth',2);
hold on
phN2 = plot(E_levelsOnN2(1:2,2),...
            100*I_mamp(i_Ef3_z3000,[1 2]),...
            '--','linewidth',2);
for i1 = 1:6,
  phP(i1) = plot(-1,0.1*i1,'.','markersize',31,'color',cmp(i1,:));
end

ph7774O = plot(E_levelsOnN2(3,2),100*I_mamp(i_Ef3_z3000,7),'s','color',cmp(2,:),'linewidth',2);
ph7774O2 = plot(E_levelsOnN2(3,2)+5.15,100*I_mamp(i_Ef3_z3000,8),'d','color',cmp(2,:),'linewidth',2);
ph8446O = plot(E_levelsOnN2(4,2),100*I_mamp(i_Ef3_z3000,9),'ks','linewidth',2);
ph8446O2 = plot(E_levelsOnN2(4,2)+5.15,100*I_mamp(i_Ef3_z3000,10),'kd','linewidth',2);

legend([phO;phO(1);phN2(1);phP([6 1 2 3 5 4])';ph7774O(1);ph7774O2(1);ph8446O(1);ph8446O2(1)],...
       '5 Hz','7 Hz','10 Hz',...
       'O','N_2',...
       '4278','8446','7774','6730',...
       'O1S','O1D','7774(O)','7774(O_2)','8446(O)','8446(O_2)',...
       'location','northeastoutside')
axis(ax_ExcT_IMA)
sX = repmat(E_levelsOnN2(:,2)',size(i_Ef3_z3000));
sY = 100*I_mamp(i_Ef3_z3000,[1 2 3 4 5 6]);
sV = repmat(E_levelsOnN2(:,3)',size(i_Ef3_z3000));
scatter(sX(:),sY(:),73,sV(:),'filled')
set(gca,...
    'xtick',2:2:20,...
    'fontsize',12)
xlabel('Excitation threshold (eV)','fontsize',ftszLT)
ylabel('Inensity Modulation (%)','fontsize',ftszLT) 


%% Figure 5: dtmax vs Ethreshold
% dtmax(:,1) = tMax4278 - tMax6730;
% dtmax(:,2) = tMax4278 - tMax7774;
% dtmax(:,3) = tMax4278 - tMax8446;
% dtmax(:,4) = tMax4278 - tMaxO1S;
% dtmax(:,5) = tMax4278 - tMaxO1D;
% dtmax(:,6) = tMax4278 - tMax7774O;
% dtmax(:,7) = tMax4278 - tMax7774O2;
% dtmax(:,8) = tMax4278 - tMax8446O;
% dtmax(:,9) = tMax4278 - tMax8446O2;

figure
cmp = [ 0            0            0
        0.6          0            0
        0.9          0            0.1
        1            0.2          0
        0.3          1            0
        0            0            1];
colormap(cmp)

phO = plot(E_levelsOnN2(3:end,2),...
           1e3*dtmax(i_Ef3_z3000,[3 4 5 6]-1),...
           '-','linewidth',2);
hold on
phN2 = plot(E_levelsOnN2(2,2),...
            1e3*dtmax(i_Ef3_z3000,[2]-1),...
            '--','linewidth',2);
for i1 = 1:6,
  phP(i1) = plot(-1,0.1*i1,'.','markersize',31,'color',cmp(i1,:));
end

ph7774O = plot(E_levelsOnN2(3,2),1e3*dtmax(i_Ef3_z3000,7-1),'s','color',cmp(2,:),'linewidth',2);
ph7774O2 = plot(E_levelsOnN2(3,2)+5.15,1e3*dtmax(i_Ef3_z3000,8-1),'d','color',cmp(2,:),'linewidth',2);
ph8446O = plot(E_levelsOnN2(4,2),1e3*dtmax(i_Ef3_z3000,9-1),'ks','linewidth',2);
ph8446O2 = plot(E_levelsOnN2(4,2)+5.15,1e3*dtmax(i_Ef3_z3000,10-1),'kd','linewidth',2);

legend([phO;phO(1);phN2(1);phP([6 1 2 3 5 4])';ph7774O(1);ph7774O2(1);ph8446O(1);ph8446O2(1)],...
       '5 Hz','7 Hz','10 Hz',...
       'O','N_2',...
       '4278','8446','7774','6730',...
       'O1S','O1D','7774(O)','7774(O_2)','8446(O)','8446(O_2)',...
       'location','northeastoutside')
axis(ax_ExcT_dt)

sX = repmat(E_levelsOnN2(2:end,2)',size(i_Ef3_z3000));
sY = 1e3*dtmax(i_Ef3_z3000,[2 3 4 5 6]-1);
sV = repmat(E_levelsOnN2(2:end,3)',size(i_Ef3_z3000));
scatter(sX(:),sY(:),73,sV(:),'filled')
set(gca,...
    'xtick',2:2:20,...
    'fontsize',12)
xlabel('Excitation threshold (eV)','fontsize',ftszLT)
ylabel('dt (ms)','fontsize',ftszLT) 
caxis([1 6])

function [t_M,I_M,t_m,I_m] = local_minMaxFinder(t,I)
% LOCAL_MINMAXFINDER - identifies local MAXima and minima
% discarding first extreme-values
%   

idxM = local_max(I);
idxM(idxM == 1) = [];
idxM(idxM == numel(I)) = [];
I_M = I(idxM);
t_M = t(idxM);
idxm = local_max(-I);
idxm(idxm == 1) = [];
idxm(idxm == numel(I)) = [];
I_m = I(idxm);
t_m = t(idxm);


function plot_ItMm(t,I_lambda,tM,IM,tm,Im,spnr,titlestring,clr)
% PLOT_ITMM - subfunction for plotting parameters in subplots with decorations
%   
subplot(3,2,spnr)

plot(t,I_lambda,'color',clr)
hold on
plot(tm,Im,'kh')
plot(tM,IM,'ch')
title(titlestring)
